from logging import Formatter, getLogger, Handler, LogRecord
from streamlit import empty, session_state
from streamlit.runtime.scriptrunner import get_script_run_ctx
from typing import Callable, Any

class StreamlitLogHandler(Handler):
    """
    Description:
        Custom log handler for Streamlit that captures and displays logs in a styled, scrollable box on the UI.

    Parameters:
        placeholder (streamlit.delta_generator.DeltaGenerator): Streamlit placeholder to inject the log box into.
    """

    def __init__(self, placeholder) -> None:
        super().__init__()
        self.placeholder = placeholder
        self.log_lines: list[str] = []

    @staticmethod
    def get_placeholder():
        """
        Retrieve or initialise a Streamlit placeholder for logging output.

        Parameters:
            None

        Returns:
            DeltaGenerator: A Streamlit placeholder object that is used to render and update log messages.
        """
        
        if "log_placeholder" not in session_state:
            session_state.log_placeholder = empty()
        return session_state.log_placeholder

    @staticmethod
    def decorate(func: Callable[..., Any]) -> Callable[..., Any]:
        """
        Function decorator that injects StreamlitLogHandler to stream logs in real time.

        Parameters:
            func (Callable[..., Any]): Target function to wrap.

        Returns:
            Callable[..., Any]: The wrapped function with logging streamed to the Streamlit UI.
        """
        
        def wrapped(*args: Any, **kwargs: Any) -> Any:
            log_placeholder = StreamlitLogHandler.get_placeholder()
            handler = StreamlitLogHandler(log_placeholder)
            formatter = Formatter("%(asctime)s | %(module)s | %(levelname)s | %(message)s", "%H:%M:%S")
            handler.setFormatter(formatter)

            root_logger = getLogger()
            root_logger.addHandler(handler)

            try:
                return func(*args, **kwargs)
            finally:
                root_logger.removeHandler(handler)

        return wrapped

    def emit(self, record: LogRecord) -> None:
        """
        Description:
            Emit a log record to the Streamlit UI. Skips rendering if not in an active Streamlit context.

        Parameters:
            record (LogRecord): Log record generated by logger.

        Returns:
            None
        """

        if get_script_run_ctx() is None:
            return

        message = self.format(record)

        if record.levelno >= 50:
            message = f'<span style="color:#f00; font-weight:bold;">{message}</span>'
        elif record.levelno >= 40:
            message = f'<span style="color:#f00;">{message}</span>'
        elif record.levelno >= 30:
            message = f'<span style="color:#ff0;">{message}</span>'
        else:
            message = f'<span style="color:#0f0;">{message}</span>'

        self.log_lines.append(message)
        formatted_logs = "\n".join(self.log_lines[-200:])

        log_display = f"""
<style>
.log-box {{
    background-color: #111;
    color: #0f0;
    padding: 10px;
    border-radius: 8px;
    font-family: monospace;
    font-size: 13px;
    height: 400px;
    overflow-y: scroll;
    white-space: pre-wrap;
    border: 1px solid #333;
}}
</style>
<div class="log-box">{formatted_logs}</div>
"""
        self.placeholder.markdown(log_display, unsafe_allow_html=True)

    def flush(self):
        
        """
        Description:
            Clears the internal log buffer.

        Parameters:
            None

        Returns:
            None
        """

        self.log_lines.clear()